<mat-form-field [ngClass]="{
    'required': required,
    'error': errorMessage,
    'disabled': disabled
  }">

  <mat-select panelClass="multi-select-panel"
              [multiple]="true"
              disableOptionCentering
              disableRipple="true"
              [(ngModel)]="selectedModel"
              [disabled]="disabled || blockSelectClick"
              #mySelect>

    <mat-select-trigger
      fxLayout="row" fxLayoutAlign="start center">

      <b-icon (click)="clearSelection()"
              (mouseenter)="blockSelectClick=true"
              (mouseleave)="blockSelectClick=false"
              [color]="iconColor"
              [icon]="resetIcon"
              [size]="iconSize"
              class="clear-selection">
      </b-icon>

      <span #triggerValueText class="trigger-value">{{triggerValue}}</span>

      <span *ngIf="hasEllipsis"
            [matTooltip]="triggerValue"
            class="number-of-selected-options"
            matTooltipPosition="above">
          ({{selectedModel.length}})
        </span>

    </mat-select-trigger>

    <b-search [hideLabelOnFocus]="true"
              label="Search"
              (keydown)="onSearchKeyDown($event)"
              (searchChange)="onSearchChange($event)">
    </b-search>

    <div class="options-wrapper"
         [ngClass]="{'no-grouping': selectionGroupOptions.length === 1 && !showSingleGroupHeader}">

      <div *ngFor="let group of selectionGroupOptions"
           class="group">

        <mat-option *ngIf="selectionGroupOptions.length > 1 || showSingleGroupHeader"
                    [value]="group.groupHeader"
                    (click)="onOptionClick(group.groupHeader)"
                    [disabled]="blockGroupHeaderOptionClick"
                    class="group-header">
          <span class="option-value">{{group.groupHeader.value}}</span>
          <div class="collapse-group"
               [ngClass]="{'collapse': group.isCollapsed}"
               (mouseenter)="blockGroupHeaderOptionClick=true"
               (mouseleave)="blockGroupHeaderOptionClick=false"
               (click)="onCollapseGroup(group)">
          </div>
        </mat-option>

        <div [hidden]="group.isCollapsed"
             class="group-options">
          <mat-option *ngFor="let option of group.options"
                      [value]="option"
                      (click)="onOptionClick(option)"
                      class="group-option">
            <span class="option-value">{{option.value}}</span>
          </mat-option>
        </div>

      </div>

    </div>

    <div fxLayout="row" fxLayoutAlign="end center"
         class="select-footer">
      <b-button (click)="cancelSelection()"
                class="cancel-button"
                size="{{buttonSize.medium}}"
                type="{{buttonType.secondary}}">
        Cancel
      </b-button>
      <b-button (click)="notifySelectionIds()"
                class="apply-button"
                size="{{buttonSize.medium}}"
                type="{{buttonType.primary}}">
        Apply
      </b-button>
    </div>
  </mat-select>

  <mat-hint *ngIf="errorMessage" class="error-message">
    {{errorMessage}}
  </mat-hint>

  <mat-hint *ngIf="hintMessage && !errorMessage" class="hint-message">
    {{hintMessage}}
  </mat-hint>

  <mat-label>{{label}}</mat-label>

</mat-form-field>
